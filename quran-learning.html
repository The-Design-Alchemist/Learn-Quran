<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learn Qur'an - Surah An-Nas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-50%) translateX(-2px);
        }

        .surah-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .surah-info {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .audio-controls {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .control-row {
            margin-bottom: 15px;
        }

        .repeat-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .repeat-option {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .repeat-option input[type="radio"] {
            accent-color: #667eea;
        }

        .repeat-count-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .repeat-count-container label {
            font-size: 0.9rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .repeat-count-container select {
            border: none;
            background: transparent;
            font-weight: bold;
            color: #2c3e50;
            cursor: pointer;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 12px 25px;
            margin: 0 8px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .control-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .verse-status {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 15px;
            font-weight: 500;
        }

        .verse-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            min-height: 400px;
        }

        .verse-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) translateX(100px);
            text-align: center;
            width: 90%;
            max-width: 800px;
            opacity: 0;
            transition: all 0.5s ease;
        }

        .verse-display.active {
            opacity: 1;
            transform: translate(-50%, -50%) translateX(0);
        }

        .verse-display.exit-left {
            opacity: 0;
            transform: translate(-50%, -50%) translateX(-100px);
        }

        .verse-display.exit-right {
            opacity: 0;
            transform: translate(-50%, -50%) translateX(100px);
        }

        .bismillah {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            color: white;
            margin: 0 auto;
            max-width: 700px;
        }

        .bismillah-arabic {
            font-size: 2.8rem;
            font-weight: bold;
            margin-bottom: 15px;
            direction: rtl;
            line-height: 1.4;
        }

        .bismillah-english {
            font-size: 1.3rem;
            opacity: 0.95;
            line-height: 1.4;
        }

        .verse-number {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-align: center;
            line-height: 50px;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .arabic-text {
            font-size: 3.5rem;
            line-height: 1.6;
            text-align: center;
            direction: rtl;
            margin-bottom: 30px;
            color: #2c3e50;
            font-weight: 500;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            word-spacing: 0.2em;
        }

        .english-text {
            font-size: 1.6rem;
            line-height: 1.5;
            color: #34495e;
            font-style: italic;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            border-radius: 10px;
            background: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
        }

        .navigation-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 25px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            gap: 20px;
        }

        .nav-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .verse-counter {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            color: #2c3e50;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .current-verse-highlight {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transform: scale(1.02);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
                min-height: 90vh;
            }
            
            .back-button {
                position: static;
                transform: none;
                margin-bottom: 15px;
                align-self: flex-start;
                font-size: 0.9rem;
                padding: 8px 16px;
            }
            
            .header {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            
            .verse-container {
                padding: 15px;
                min-height: 350px;
            }
            
            .verse-display {
                width: 95%;
            }
            
            .surah-title {
                font-size: 2rem;
            }
            
            .arabic-text {
                font-size: 2.5rem;
                line-height: 1.5;
                word-spacing: 0.1em;
            }
            
            .english-text {
                font-size: 1.3rem;
                padding: 15px;
            }
            
            .bismillah-arabic {
                font-size: 2.2rem;
            }
            
            .bismillah-english {
                font-size: 1.1rem;
            }
            
            .control-button, .nav-button {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .verse-counter {
                font-size: 0.9rem;
            }

            .repeat-controls {
                gap: 10px;
            }

            .repeat-option {
                font-size: 0.8rem;
                padding: 6px 12px;
            }

            .repeat-count-container {
                font-size: 0.8rem;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-button">
                â†ï¸ Back to Home
            </a>
            <h1 class="surah-title">Ø³ÙÙˆØ±ÙØ©Ù Ø§Ù„Ù†ÙÙ‘Ø§Ø³</h1>
            <div class="surah-info">Surah An-Nas (The Mankind) â€¢ Chapter 114 â€¢ 6 Verses</div>
        </div>

        <div class="audio-controls">
            <div class="control-row">
                <button class="control-button" onclick="startRecitation()">â–¶ï¸ Start Recitation</button>
                <button class="control-button" onclick="stopRecitation()">â¹ï¸ Stop</button>
                <button class="control-button" onclick="pauseRecitation()">â¸ï¸ Pause</button>
            </div>
            
            <div class="repeat-controls">
                <div class="repeat-option">
                    <input type="radio" id="no-repeat" name="repeatMode" value="none" checked onchange="changeRepeatMode()">
                    <label for="no-repeat">No Repeat</label>
                </div>
                
                <div class="repeat-option">
                    <input type="radio" id="repeat-verse" name="repeatMode" value="verse" onchange="changeRepeatMode()">
                    <label for="repeat-verse">ğŸ” Repeat Current Verse</label>
                </div>
                
                <div class="repeat-option">
                    <input type="radio" id="repeat-surah" name="repeatMode" value="surah" onchange="changeRepeatMode()">
                    <label for="repeat-surah">ğŸ”„ Repeat Entire Surah</label>
                </div>
                
                <div class="repeat-count-container">
                    <label for="repeat-count">Times:</label>
                    <select id="repeat-count" onchange="changeRepeatCount()">
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="5">5</option>
                        <option value="7">7</option>
                        <option value="10">10</option>
                        <option value="infinite">âˆ</option>
                    </select>
                </div>
            </div>
            
            <div class="verse-status" id="status">Ready to recite with Mishary Alafasy</div>
        </div>

        <div class="verse-container">
            <!-- Bismillah -->
            <div class="verse-display active" id="bismillah-display">
                <div class="bismillah">
                    <div class="bismillah-arabic">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</div>
                    <div class="bismillah-english">In the name of Allah, the Most Gracious, the Most Merciful</div>
                </div>
            </div>

            <!-- Verses 1-6 -->
            <div class="verse-display" id="verse-1-display">
                <div class="verse-number">1</div>
                <div class="arabic-text">Ù‚ÙÙ„Ù’ Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙØ±ÙØ¨ÙÙ‘ Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù</div>
                <div class="english-text">Say: "I seek refuge with the Lord of mankind,"</div>
            </div>

            <div class="verse-display" id="verse-2-display">
                <div class="verse-number">2</div>
                <div class="arabic-text">Ù…ÙÙ„ÙÙƒÙ Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù</div>
                <div class="english-text">"The King of mankind,"</div>
            </div>

            <div class="verse-display" id="verse-3-display">
                <div class="verse-number">3</div>
                <div class="arabic-text">Ø¥ÙÙ„ÙÙ°Ù‡Ù Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù</div>
                <div class="english-text">"The God of mankind,"</div>
            </div>

            <div class="verse-display" id="verse-4-display">
                <div class="verse-number">4</div>
                <div class="arabic-text">Ù…ÙÙ† Ø´ÙØ±ÙÙ‘ Ø§Ù„Ù’ÙˆÙØ³Ù’ÙˆÙØ§Ø³Ù Ø§Ù„Ù’Ø®ÙÙ†ÙÙ‘Ø§Ø³Ù</div>
                <div class="english-text">"From the evil of the whisperer who withdraws,"</div>
            </div>

            <div class="verse-display" id="verse-5-display">
                <div class="verse-number">5</div>
                <div class="arabic-text">Ø§Ù„ÙÙ‘Ø°ÙÙŠ ÙŠÙÙˆÙØ³Ù’ÙˆÙØ³Ù ÙÙÙŠ ØµÙØ¯ÙÙˆØ±Ù Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù</div>
                <div class="english-text">"Who whispers in the hearts of mankind,"</div>
            </div>

            <div class="verse-display" id="verse-6-display">
                <div class="verse-number">6</div>
                <div class="arabic-text">Ù…ÙÙ†Ù Ø§Ù„Ù’Ø¬ÙÙ†ÙÙ‘Ø©Ù ÙˆÙØ§Ù„Ù†ÙÙ‘Ø§Ø³Ù</div>
                <div class="english-text">"From among the jinn and mankind."</div>
            </div>
        </div>

        <div class="navigation-controls">
            <button class="nav-button" id="prev-btn" onclick="previousVerse()">â—€ï¸ Previous</button>
            <div class="verse-counter" id="verse-counter">Bismillah</div>
            <button class="nav-button" id="next-btn" onclick="nextVerse()">Next â–¶ï¸</button>
        </div>
    </div>

    <script>
        let currentAudio = null;
        let currentVerseIndex = 0; // 0 = Bismillah, 1-6 = verses
        let isReciting = false;
        let isPaused = false;
        let autoAdvance = true;
        
        // Repeat mode variables
        let repeatMode = 'none'; // 'none', 'verse', 'surah'
        let repeatCount = 3;
        let currentRepeatCount = 0;
        let surahRepeatCount = 0;

        const verses = [
            { number: 'Bismillah', text: "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù", id: "bismillah-display", hasAudio: false },
            { number: 1, text: "Ù‚ÙÙ„Ù’ Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙØ±ÙØ¨ÙÙ‘ Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù", id: "verse-1-display", hasAudio: true },
            { number: 2, text: "Ù…ÙÙ„ÙÙƒÙ Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù", id: "verse-2-display", hasAudio: true },
            { number: 3, text: "Ø¥ÙÙ„ÙÙ°Ù‡Ù Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù", id: "verse-3-display", hasAudio: true },
            { number: 4, text: "Ù…ÙÙ† Ø´ÙØ±ÙÙ‘ Ø§Ù„Ù’ÙˆÙØ³Ù’ÙˆÙØ§Ø³Ù Ø§Ù„Ù’Ø®ÙÙ†ÙÙ‘Ø§Ø³Ù", id: "verse-4-display", hasAudio: true },
            { number: 5, text: "Ø§Ù„ÙÙ‘Ø°ÙÙŠ ÙŠÙÙˆÙØ³Ù’ÙˆÙØ³Ù ÙÙÙŠ ØµÙØ¯ÙÙˆØ±Ù Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù", id: "verse-5-display", hasAudio: true },
            { number: 6, text: "Ù…ÙÙ†Ù Ø§Ù„Ù’Ø¬ÙÙ†ÙÙ‘Ø©Ù ÙˆÙØ§Ù„Ù†ÙÙ‘Ø§Ø³Ù", id: "verse-6-display", hasAudio: true }
        ];

        // Media Session API for notification controls
        function initializeMediaSession() {
            if ('mediaSession' in navigator) {
                // iOS fix: Set initial metadata first
                updateMediaSessionMetadata();

                // Basic playback controls
                navigator.mediaSession.setActionHandler('play', () => {
                    console.log('Media Session: Play pressed');
                    startRecitation();
                });

                navigator.mediaSession.setActionHandler('pause', () => {
                    console.log('Media Session: Pause pressed');
                    pauseRecitation();
                });

                navigator.mediaSession.setActionHandler('stop', () => {
                    console.log('Media Session: Stop pressed');
                    stopRecitation();
                });

                // Navigation controls - iOS has limited support, but we'll try all options
                try {
                    navigator.mediaSession.setActionHandler('previoustrack', () => {
                        console.log('Media Session: Previous track pressed');
                        handlePreviousFromMedia();
                    });
                } catch (e) {
                    console.log('Previous track not supported');
                }

                try {
                    navigator.mediaSession.setActionHandler('nexttrack', () => {
                        console.log('Media Session: Next track pressed');
                        handleNextFromMedia();
                    });
                } catch (e) {
                    console.log('Next track not supported');
                }

                // iOS fallback controls
                try {
                    navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                        console.log('Media Session: Seek backward pressed');
                        handlePreviousFromMedia();
                    });
                } catch (e) {
                    console.log('Seek backward not supported');
                }

                try {
                    navigator.mediaSession.setActionHandler('seekforward', (details) => {
                        console.log('Media Session: Seek forward pressed');
                        handleNextFromMedia();
                    });
                } catch (e) {
                    console.log('Seek forward not supported');
                }

                // Set initial playback state
                navigator.mediaSession.playbackState = 'none';
                
                console.log('Media Session initialized with iOS compatibility');
            }
        }

        function updateMediaSessionPlaybackState() {
            if ('mediaSession' in navigator) {
                try {
                    if (isReciting && !isPaused) {
                        navigator.mediaSession.playbackState = 'playing';
                        console.log('Media session state: playing');
                    } else if (isPaused) {
                        navigator.mediaSession.playbackState = 'paused';
                        console.log('Media session state: paused');
                    } else {
                        navigator.mediaSession.playbackState = 'none';
                        console.log('Media session state: none');
                    }
                } catch (error) {
                    console.error('Error updating media session playback state:', error);
                }
            }
        }

        // Handle previous verse from media controls
        function handlePreviousFromMedia() {
            if (currentVerseIndex > 0) {
                // Stop current audio if playing
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                
                // Move to previous verse
                previousVerse();
                
                // If we were reciting, start playing the new verse
                if (isReciting && !isPaused) {
                    setTimeout(() => {
                        playCurrentVerse();
                    }, 300);
                }
                
                updateStatus(`Previous verse - ${verses[currentVerseIndex].number === 'Bismillah' ? 'Bismillah' : `Verse ${verses[currentVerseIndex].number}`}`);
            }
        }

        // Handle next verse from media controls
        function handleNextFromMedia() {
            if (currentVerseIndex < verses.length - 1) {
                // Stop current audio if playing
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                
                // Move to next verse
                nextVerse();
                
                // If we were reciting, start playing the new verse
                if (isReciting && !isPaused) {
                    setTimeout(() => {
                        playCurrentVerse();
                    }, 300);
                }
                
                updateStatus(`Next verse - ${verses[currentVerseIndex].number === 'Bismillah' ? 'Bismillah' : `Verse ${verses[currentVerseIndex].number}`}`);
            } else {
                // At the end - handle repeat mode
                if (repeatMode === 'surah') {
                    surahRepeatCount++;
                    if (repeatCount === 'infinite' || surahRepeatCount < repeatCount) {
                        currentVerseIndex = 0;
                        showVerse(currentVerseIndex, 'right');
                        if (isReciting && !isPaused) {
                            setTimeout(() => {
                                playCurrentVerse();
                            }, 300);
                        }
                        updateStatus(`Repeating Surah - ${surahRepeatCount}/${repeatCount === 'infinite' ? 'âˆ' : repeatCount}`);
                    }
                }
            }
        }

        function updateMediaSessionMetadata() {
            if ('mediaSession' in navigator) {
                const currentVerse = verses[currentVerseIndex];
                let title = currentVerse.number === 'Bismillah' ? 
                    'Bismillah' : 
                    `Verse ${currentVerse.number} of 6`;
                
                // Add repeat mode info to title
                if (repeatMode === 'verse' && currentRepeatCount > 0) {
                    title += ` (ğŸ” ${currentRepeatCount}/${repeatCount === 'infinite' ? 'âˆ' : repeatCount})`;
                } else if (repeatMode === 'surah' && surahRepeatCount > 0) {
                    title += ` (ğŸ”„ ${surahRepeatCount}/${repeatCount === 'infinite' ? 'âˆ' : repeatCount})`;
                } else if (repeatMode === 'verse') {
                    title += ' (ğŸ” Repeat Verse)';
                } else if (repeatMode === 'surah') {
                    title += ' (ğŸ”„ Repeat Surah)';
                }
                
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: title,
                    artist: 'Mishary Rashid Alafasy',
                    album: 'Surah An-Nas - Chapter 114',
                    artwork: [
                        { src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23667eea;stop-opacity:1" /><stop offset="100%" style="stop-color:%23764ba2;stop-opacity:1" /></linearGradient></defs><rect width="512" height="512" fill="url(%23grad1)"/><text x="256" y="120" font-family="Arial, sans-serif" font-size="80" font-weight="bold" text-anchor="middle" fill="white">Ø§Ù„Ù‚Ø±Ø¢Ù†</text><text x="256" y="180" font-family="Arial, sans-serif" font-size="32" text-anchor="middle" fill="white" opacity="0.9">Surah An-Nas</text><text x="256" y="240" font-family="Arial, sans-serif" font-size="48" font-weight="bold" text-anchor="middle" fill="white">' + (currentVerse.number === 'Bismillah' ? 'Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù' : currentVerse.number) + '</text><text x="256" y="300" font-family="Arial, sans-serif" font-size="24" text-anchor="middle" fill="white" opacity="0.8">' + (currentVerse.number === 'Bismillah' ? 'Bismillah' : `Verse ${currentVerse.number}`) + '</text><text x="256" y="340" font-family="Arial, sans-serif" font-size="20" text-anchor="middle" fill="white" opacity="0.7">Mishary Alafasy</text>' + (repeatMode !== 'none' ? '<text x="256" y="380" font-family="Arial, sans-serif" font-size="18" text-anchor="middle" fill="white" opacity="0.6">' + (repeatMode === 'verse' ? 'ğŸ” Repeat Verse' : 'ğŸ”„ Repeat Surah') + '</text>' : '') + '</svg>', sizes: '512x512', type: 'image/svg+xml' }
                    ]
                });
            }
        }

        function updateMediaSessionPlaybackState() {
            if ('mediaSession' in navigator) {
                if (isReciting && !isPaused) {
                    navigator.mediaSession.playbackState = 'playing';
                } else if (isPaused) {
                    navigator.mediaSession.playbackState = 'paused';
                } else {
                    navigator.mediaSession.playbackState = 'none';
                }
            }
        }

        function updateStatus(message) {
            const statusElement = document.getElementById('status');
            let fullMessage = message;
            
            // Add repeat info to status
            if (repeatMode === 'verse' && currentRepeatCount > 0) {
                const remaining = repeatCount === 'infinite' ? 'âˆ' : (repeatCount - currentRepeatCount);
                fullMessage += ` (Repeating: ${currentRepeatCount}/${repeatCount === 'infinite' ? 'âˆ' : repeatCount})`;
            } else if (repeatMode === 'surah' && surahRepeatCount > 0) {
                const remaining = repeatCount === 'infinite' ? 'âˆ' : (repeatCount - surahRepeatCount);
                fullMessage += ` (Surah repeat: ${surahRepeatCount}/${repeatCount === 'infinite' ? 'âˆ' : repeatCount})`;
            }
            
            statusElement.textContent = fullMessage;
        }

        function changeRepeatMode() {
            const selectedMode = document.querySelector('input[name="repeatMode"]:checked').value;
            repeatMode = selectedMode;
            
            // Reset counters when changing mode
            currentRepeatCount = 0;
            surahRepeatCount = 0;
            
            updateStatus(`Repeat mode: ${repeatMode === 'none' ? 'No repeat' : 
                        repeatMode === 'verse' ? 'Repeat current verse' : 'Repeat entire surah'}`);
        }

        function changeRepeatCount() {
            const countSelect = document.getElementById('repeat-count');
            repeatCount = countSelect.value === 'infinite' ? 'infinite' : parseInt(countSelect.value);
            
            updateStatus(`Repeat count set to: ${repeatCount === 'infinite' ? 'infinite' : repeatCount}`);
        }

        function updateVerseCounter() {
            const counter = document.getElementById('verse-counter');
            const current = verses[currentVerseIndex];
            counter.textContent = current.number === 'Bismillah' ? 'Bismillah' : `Verse ${current.number} of 6`;
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            prevBtn.disabled = currentVerseIndex === 0;
            nextBtn.disabled = currentVerseIndex === verses.length - 1;
        }

        function showVerse(index, direction = 'right') {
            // Hide all verses
            document.querySelectorAll('.verse-display').forEach(verse => {
                verse.classList.remove('active');
                if (direction === 'right') {
                    verse.classList.add('exit-left');
                } else {
                    verse.classList.add('exit-right');
                }
            });

            // Show current verse after a short delay for animation
            setTimeout(() => {
                document.querySelectorAll('.verse-display').forEach(verse => {
                    verse.classList.remove('exit-left', 'exit-right');
                });
                
                const currentVerse = document.getElementById(verses[index].id);
                currentVerse.classList.add('active');
                
                // Add highlight if currently reciting this verse
                if (isReciting && currentVerseIndex === index) {
                    currentVerse.classList.add('current-verse-highlight');
                } else {
                    currentVerse.classList.remove('current-verse-highlight');
                }
            }, 100);

            updateVerseCounter();
            updateNavigationButtons();
            updateMediaSessionMetadata();
        }

        function nextVerse() {
            if (currentVerseIndex < verses.length - 1) {
                currentVerseIndex++;
                showVerse(currentVerseIndex, 'right');
                
                // If reciting and auto-advance was disabled, re-enable it
                if (isReciting) {
                    autoAdvance = true;
                }
            }
        }

        function previousVerse() {
            if (currentVerseIndex > 0) {
                currentVerseIndex--;
                showVerse(currentVerseIndex, 'left');
                
                // Disable auto-advance when manually navigating
                autoAdvance = false;
            }
        }

        async function loadAudio(verseNumber) {
            const paddedVerse = verseNumber.toString().padStart(3, '0');
            
            // Multiple audio sources for better iOS compatibility
            const audioSources = [
                `https://everyayah.com/data/Alafasy_128kbps/114${paddedVerse}.mp3`,
                `https://server8.mp3quran.net/afs/114${paddedVerse}.mp3`,
                `https://download.quranicaudio.com/quran/alafasy/114${paddedVerse}.mp3`
            ];
            
            console.log(`Loading audio for verse ${verseNumber} on iOS/Safari...`);
            
            for (let i = 0; i < audioSources.length; i++) {
                const audioUrl = audioSources[i];
                console.log(`Trying source ${i + 1}: ${audioUrl}`);
                
                try {
                    const audio = new Audio();
                    
                    // iOS specific audio settings
                    audio.preload = 'auto';
                    audio.crossOrigin = 'anonymous';
                    
                    // iOS Safari specific attributes
                    if (audio.setAttribute) {
                        audio.setAttribute('playsinline', 'true');
                        audio.setAttribute('webkit-playsinline', 'true');
                    }
                    
                    const isLoaded = await new Promise((resolve) => {
                        let loaded = false;
                        let timeout;
                        
                        const onSuccess = () => {
                            if (!loaded) {
                                loaded = true;
                                clearTimeout(timeout);
                                console.log(`âœ… Audio source ${i + 1} loaded successfully`);
                                resolve(true);
                            }
                        };
                        
                        const onError = (e) => {
                            if (!loaded) {
                                loaded = true;
                                clearTimeout(timeout);
                                console.log(`âŒ Audio source ${i + 1} failed:`, e.type);
                                resolve(false);
                            }
                        };

                        // Multiple event listeners for iOS compatibility
                        audio.addEventListener('canplay', onSuccess, { once: true });
                        audio.addEventListener('canplaythrough', onSuccess, { once: true });
                        audio.addEventListener('loadeddata', onSuccess, { once: true });
                        audio.addEventListener('loadedmetadata', onSuccess, { once: true });
                        
                        audio.addEventListener('error', onError, { once: true });
                        audio.addEventListener('abort', onError, { once: true });
                        
                        // Set source and load
                        audio.src = audioUrl;
                        audio.load();
                        
                        // iOS needs longer timeout
                        timeout = setTimeout(() => {
                            if (!loaded) {
                                loaded = true;
                                console.log(`â±ï¸ Audio source ${i + 1} timeout after 8 seconds`);
                                resolve(false);
                            }
                        }, 8000); // Increased timeout for iOS
                    });

                    if (isLoaded) {
                        console.log(`ğŸµ Successfully loaded audio from source ${i + 1}`);
                        return audioUrl;
                    }
                } catch (error) {
                    console.error(`Error with audio source ${i + 1}:`, error);
                }
            }
            
            // If all sources fail, throw error
            throw new Error(`All audio sources failed for verse ${verseNumber}`);
        }

        async function playCurrentVerse() {
            const verse = verses[currentVerseIndex];
            
            // Skip Bismillah (has no audio)
            if (!verse.hasAudio) {
                if (autoAdvance && currentVerseIndex < verses.length - 1) {
                    setTimeout(() => {
                        currentVerseIndex++;
                        showVerse(currentVerseIndex, 'right');
                        playCurrentVerse();
                    }, 2000); // Show Bismillah for 2 seconds
                }
                return;
            }

            updateStatus(`Loading verse ${verse.number} audio...`);
            console.log(`ğŸµ Starting to load verse ${verse.number}`);

            try {
                // Stop previous audio completely
                if (currentAudio) {
                    currentAudio.pause();
                    if (currentAudio.endedHandler) {
                        currentAudio.removeEventListener('ended', currentAudio.endedHandler);
                    }
                    if (currentAudio.errorHandler) {
                        currentAudio.removeEventListener('error', currentAudio.errorHandler);
                    }
                    currentAudio = null;
                }

                const audioUrl = await loadAudio(verse.number);
                console.log(`âœ… Audio URL obtained: ${audioUrl}`);
                
                // Create new audio with iOS optimizations
                currentAudio = new Audio();
                currentAudio.preload = 'auto';
                currentAudio.crossOrigin = 'anonymous';
                
                // iOS Safari specific settings
                if (currentAudio.setAttribute) {
                    currentAudio.setAttribute('playsinline', 'true');
                    currentAudio.setAttribute('webkit-playsinline', 'true');
                }
                
                // Set source
                currentAudio.src = audioUrl;
                
                updateStatus(`Playing verse ${verse.number} - Mishary Alafasy`);
                updateMediaSessionPlaybackState();

                // Highlight current verse
                document.getElementById(verse.id).classList.add('current-verse-highlight');

                // Store event handlers for cleanup
                currentAudio.endedHandler = function() {
                    console.log(`ğŸ“ Verse ${verse.number} playback ended`);
                    
                    // Remove highlight
                    document.getElementById(verse.id).classList.remove('current-verse-highlight');
                    
                    // iOS fix: Add delay to prevent rapid progression
                    setTimeout(() => {
                        if (isReciting && !isPaused && autoAdvance) {
                            console.log(`â¡ï¸ Moving to handle verse completion`);
                            handleVerseCompletion();
                        }
                    }, 800); // Increased delay for iOS stability
                };

                currentAudio.errorHandler = function(event) {
                    console.error(`âŒ Audio playback error for verse ${verse.number}:`, event);
                    document.getElementById(verse.id).classList.remove('current-verse-highlight');
                    updateStatus(`Audio error for verse ${verse.number}, trying next...`);
                    
                    if (autoAdvance && isReciting && !isPaused) {
                        setTimeout(() => {
                            console.log(`â­ï¸ Skipping to next verse due to error`);
                            handleVerseCompletion();
                        }, 1500);
                    }
                };

                currentAudio.addEventListener('ended', currentAudio.endedHandler);
                currentAudio.addEventListener('error', currentAudio.errorHandler);

                // iOS fix: Ensure media session is updated before playing
                updateMediaSessionMetadata();
                updateMediaSessionPlaybackState();

                // Play with better error handling for iOS
                console.log(`â–¶ï¸ Attempting to play verse ${verse.number}`);
                
                await currentAudio.play();
                console.log(`ğŸµ Successfully playing verse ${verse.number}`);

            } catch (error) {
                console.error(`ğŸ’¥ Complete failure loading/playing verse ${verse.number}:`, error);
                updateStatus(`Cannot load verse ${verse.number} audio. Skipping...`);
                
                // Remove highlight if it was added
                document.getElementById(verse.id).classList.remove('current-verse-highlight');
                
                if (autoAdvance && isReciting && !isPaused) {
                    setTimeout(() => {
                        console.log(`â­ï¸ Skipping verse ${verse.number} due to complete failure`);
                        handleVerseCompletion();
                    }, 2000);
                }
            }
        }

        function handleVerseCompletion() {
            console.log('Handling verse completion...');
            
            // Handle repeat modes
            if (repeatMode === 'verse') {
                currentRepeatCount++;
                console.log(`Verse repeat: ${currentRepeatCount}/${repeatCount}`);
                
                if (repeatCount === 'infinite' || currentRepeatCount < repeatCount) {
                    // Repeat current verse - iOS fix: add delay
                    updateStatus(`Repeating verse ${verses[currentVerseIndex].number} (${currentRepeatCount}/${repeatCount === 'infinite' ? 'âˆ' : repeatCount})`);
                    setTimeout(() => {
                        if (isReciting && !isPaused) {
                            playCurrentVerse();
                        }
                    }, 1000); // 1 second delay for iOS
                    return;
                } else {
                    // Finished repeating, move to next verse
                    currentRepeatCount = 0;
                }
            }
            
            // Move to next verse
            if (currentVerseIndex < verses.length - 1) {
                setTimeout(() => {
                    if (isReciting && !isPaused && autoAdvance) {
                        currentVerseIndex++;
                        showVerse(currentVerseIndex, 'right');
                        playCurrentVerse();
                    }
                }, 1500); // Increased delay for iOS
            } else {
                // End of surah - check surah repeat mode
                if (repeatMode === 'surah') {
                    surahRepeatCount++;
                    console.log(`Surah repeat: ${surahRepeatCount}/${repeatCount}`);
                    
                    if (repeatCount === 'infinite' || surahRepeatCount < repeatCount) {
                        // Repeat entire surah
                        updateStatus(`Repeating Surah (${surahRepeatCount}/${repeatCount === 'infinite' ? 'âˆ' : repeatCount})`);
                        setTimeout(() => {
                            if (isReciting && !isPaused) {
                                currentVerseIndex = 0; // Start from Bismillah
                                showVerse(currentVerseIndex, 'right');
                                playCurrentVerse();
                            }
                        }, 2000); // 2 second delay for surah repeat
                        return;
                    }
                }
                
                // Recitation complete
                console.log('Recitation completed');
                stopRecitation();
            }
        }

        function startRecitation() {
            console.log('Starting recitation...');
            
            if (!isReciting) {
                isReciting = true;
                isPaused = false;
                autoAdvance = true;
                currentRepeatCount = 0;
                surahRepeatCount = 0;
                
                document.querySelector('.control-button').disabled = true;
                updateStatus('Starting recitation...');
                updateMediaSessionPlaybackState();
                
                // iOS fix: Small delay before starting playback
                setTimeout(() => {
                    playCurrentVerse();
                }, 200);
                
            } else if (isPaused) {
                console.log('Resuming from pause...');
                // Resume from pause
                isPaused = false;
                autoAdvance = true;
                updateMediaSessionPlaybackState();
                
                if (currentAudio && !currentAudio.ended) {
                    currentAudio.play().catch(error => {
                        console.error('Resume error:', error);
                        // If resume fails, restart current verse
                        playCurrentVerse();
                    });
                    updateStatus(`Resuming verse ${verses[currentVerseIndex].number}...`);
                } else {
                    // Audio ended or doesn't exist, restart current verse
                    playCurrentVerse();
                }
            }
        }

        function pauseRecitation() {
            console.log('Pausing recitation...');
            
            if (isReciting && !isPaused) {
                isPaused = true;
                autoAdvance = false;
                updateMediaSessionPlaybackState();
                
                if (currentAudio && !currentAudio.paused) {
                    currentAudio.pause();
                }
                updateStatus('Recitation paused');
            }
        }

        function stopRecitation() {
            console.log('Stopping recitation...');
            
            isReciting = false;
            isPaused = false;
            autoAdvance = true;
            currentRepeatCount = 0;
            surahRepeatCount = 0;
            
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                // iOS fix: Properly clean up event listeners
                if (currentAudio.endedHandler) {
                    currentAudio.removeEventListener('ended', currentAudio.endedHandler);
                }
                if (currentAudio.errorHandler) {
                    currentAudio.removeEventListener('error', currentAudio.errorHandler);
                }
                currentAudio = null;
            }
            
            // Remove all highlights
            document.querySelectorAll('.verse-display').forEach(verse => {
                verse.classList.remove('current-verse-highlight');
            });
            
            document.querySelector('.control-button').disabled = false;
            updateMediaSessionPlaybackState();
            updateStatus('Recitation stopped');
        }

        // Initialize
        window.addEventListener('load', () => {
            showVerse(0);
            updateStatus('Ready to recite with Mishary Alafasy');
            initializeMediaSession();
            updateMediaSessionMetadata();
        });
    </script>
</body>
</html>